name: Build Custom Talos Images (CozyStack + ARM64)

on:
  push:
    branches: [ main ]
    paths:
      - 'patches/**'
      - '.github/workflows/build-talos-images.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'patches/**' 
      - '.github/workflows/build-talos-images.yml'
  workflow_dispatch:
    inputs:
      cozystack_ref:
        description: 'CozyStack git ref (branch/tag/commit)'
        required: false
        default: 'merged-branches'  # Use proven working branch
      base_commit:
        description: 'Base commit from kingdonb fork'
        required: false
        default: 'c21b1a86'  # Latest working commit
      build_variant:
        description: 'Build variant'
        required: false
        default: 'both'
        type: choice
        options:
          - 'both'
          - 'spin-only'
          - 'spin-tailscale'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: urmanac/talos-cozystack-demo

jobs:
  build-cozystack-talos-arm64:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      kernel-digest: ${{ steps.assets.outputs.kernel-digest }}
      initramfs-digest: ${{ steps.assets.outputs.initramfs-digest }}
      talos-version: ${{ steps.build.outputs.talos-version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          # Install CozyStack build dependencies
          sudo apt-get update
          sudo apt-get install -y skopeo jq
          
          # Install mikefarah/yq (required by CozyStack)
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          
          # Verify versions
          docker --version
          skopeo --version  
          jq --version
          yq --version

      - name: Clone and setup CozyStack (proven branch)
        run: |
          # Clone kingdonb fork at proven working commit
          git clone https://github.com/kingdonb/cozystack.git cozystack-upstream
          cd cozystack-upstream
          git checkout ${{ github.event.inputs.cozystack_ref || 'merged-branches' }}
          
          # Reset to specific base commit if provided
          if [[ -n "${{ github.event.inputs.base_commit }}" ]]; then
            git reset --hard ${{ github.event.inputs.base_commit }}
          fi
          
          echo "COZYSTACK_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "Building from proven commit: $(git log -1 --oneline)"

      - name: Apply ARM64 conversion patches
        run: |
          cd cozystack-upstream
          
          # Apply our patches to convert x86_64 â†’ ARM64
          echo "Applying patches to convert proven x86_64 build to ARM64..."
          for patch in ../patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying $(basename "$patch")"
              git apply "$patch" || {
                echo "Failed to apply $patch"
                git status
                exit 1
              }
            fi
          done
          
          # Verify patch application
          echo "Patches applied successfully:"
          git status --porcelain

      - name: Build Talos images following proven pattern
        id: build
        run: |
          cd cozystack-upstream/packages/core/installer
          
          # Build variants based on proven pattern
          VARIANT="${{ github.event.inputs.build_variant || 'both' }}"
          
          case "$VARIANT" in
            "spin-only")
              echo "Building Spin-only variant"
              export TAILSCALE_ENABLED=false
              ./hack/gen-profiles.sh
              make talos-metal talos-kernel talos-initramfs
              TAGS="spin-only"
              ;;
            "spin-tailscale")
              echo "Building Spin+Tailscale variant"  
              export TAILSCALE_ENABLED=true
              ./hack/gen-profiles.sh
              make talos-metal talos-kernel talos-initramfs
              TAGS="spin-tailscale"
              ;;
            "both")
              echo "Building both variants"
              # Build spin-only first
              export TAILSCALE_ENABLED=false
              ./hack/gen-profiles.sh
              make talos-metal talos-kernel talos-initramfs
              
              # Rename assets
              cd ../../../
              mkdir -p _out/assets/spin-only
              mv _out/assets/kernel-arm64 _out/assets/spin-only/
              mv _out/assets/initramfs-metal-arm64.xz _out/assets/spin-only/
              
              # Build spin-tailscale
              cd packages/core/installer
              export TAILSCALE_ENABLED=true  
              ./hack/gen-profiles.sh
              make talos-metal talos-kernel talos-initramfs
              
              # Rename assets
              cd ../../../
              mkdir -p _out/assets/spin-tailscale
              mv _out/assets/kernel-arm64 _out/assets/spin-tailscale/
              mv _out/assets/initramfs-metal-arm64.xz _out/assets/spin-tailscale/
              
              TAGS="both"
              ;;
          esac
          
          # Get Talos version from build
          TALOS_VERSION=$(awk '/^version:/ {print $2}' packages/core/installer/images/talos/profiles/metal.yaml)
          echo "talos-version=$TALOS_VERSION" >> $GITHUB_OUTPUT
          echo "build-variant=$TAGS" >> $GITHUB_OUTPUT
          echo "Built Talos version: $TALOS_VERSION, variant: $TAGS"

      - name: Extract and package assets
        id: assets
        run: |
          cd cozystack-upstream
          
          # Create output directory structure
          mkdir -p assets/talos/arm64
          
          # Copy built assets
          cp _out/assets/kernel-arm64 assets/talos/arm64/vmlinuz
          cp _out/assets/initramfs-metal-arm64.xz assets/talos/arm64/initramfs.xz
          
          # Create checksums
          cd assets/talos/arm64
          sha256sum vmlinuz > vmlinuz.sha256
          sha256sum initramfs.xz > initramfs.xz.sha256
          
          # Output digests for tracking
          KERNEL_DIGEST=$(sha256sum vmlinuz | cut -d' ' -f1)
          INITRAMFS_DIGEST=$(sha256sum initramfs.xz | cut -d' ' -f1)
          
          echo "kernel-digest=sha256:$KERNEL_DIGEST" >> $GITHUB_OUTPUT
          echo "initramfs-digest=sha256:$INITRAMFS_DIGEST" >> $GITHUB_OUTPUT

      - name: Create asset container
        run: |
          cd cozystack-upstream
          
          # Create Dockerfile for asset container
          cat > Dockerfile.assets << 'EOF'
          FROM scratch
          COPY assets/ /assets/
          COPY scripts/extract-boot-assets.sh /extract-boot-assets
          ENTRYPOINT ["/extract-boot-assets"]
          EOF
          
          # Create extraction script
          mkdir -p scripts
          cat > scripts/extract-boot-assets.sh << 'EOF'
          #!/bin/sh
          set -e
          OUTPUT_DIR=${1:-/output}
          mkdir -p "$OUTPUT_DIR"
          cp -r /assets/* "$OUTPUT_DIR/"
          echo "Assets extracted to $OUTPUT_DIR"
          ls -la "$OUTPUT_DIR"
          EOF
          chmod +x scripts/extract-boot-assets.sh

      - name: Extract metadata and build container
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Talos version tag
            type=raw,value=${{ steps.build.outputs.talos-version }}-arm64-spin-tailscale
            
            # Date-based tag for reproducibility  
            type=raw,value={{date 'YYYYMMDD'}}-{{sha}}-arm64
            
            # Demo stable tag (only on main branch)
            type=raw,value=demo-stable,enable={{is_default_branch}}
            
            # Latest tag (only on main branch)
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push asset container
        uses: docker/build-push-action@v5
        with:
          context: ./cozystack-upstream
          file: ./cozystack-upstream/Dockerfile.assets
          platforms: linux/arm64,linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate build summary
        run: |
          echo "## ðŸš€ Custom Talos Image Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags pushed:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull commands:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest build:" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# For AWS bastion setup:" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable" >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm -v /opt/matchbox/assets:/output \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable \\" >> $GITHUB_STEP_SUMMARY
          echo "  extract-boot-assets /output/talos/custom/" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  test-image-smoke:
    runs-on: ubuntu-latest
    needs: build-cozystack-talos-arm64
    steps:
      - name: Test asset container extraction
        run: |
          # Test that container can be pulled and assets extracted
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable
          
          # Test asset extraction
          mkdir -p /tmp/test-assets
          docker run --rm -v /tmp/test-assets:/output ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable
          
          # Verify ARM64 assets exist
          test -f /tmp/test-assets/talos/arm64/vmlinuz
          test -f /tmp/test-assets/talos/arm64/initramfs.xz
          test -f /tmp/test-assets/talos/arm64/vmlinuz.sha256
          test -f /tmp/test-assets/talos/arm64/initramfs.xz.sha256
          
          echo "âœ… CozyStack ARM64 asset tests passed"
          echo "Assets verified:"
          ls -la /tmp/test-assets/talos/arm64/

  update-docs:
    runs-on: ubuntu-latest
    needs: [build-cozystack-talos-arm64, test-image-smoke]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update build documentation
        run: |
          # Update docs with latest build info
          TALOS_VERSION="${{ needs.build-cozystack-talos-arm64.outputs.talos-version }}"
          KERNEL_DIGEST="${{ needs.build-cozystack-talos-arm64.outputs.kernel-digest }}"
          INITRAMFS_DIGEST="${{ needs.build-cozystack-talos-arm64.outputs.initramfs-digest }}"
          DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          cat > docs/LATEST-BUILD.md << EOF
          # Latest CozyStack ARM64 Talos Build
          
          **Built:** $DATE  
          **Talos Version:** \`$TALOS_VERSION\`  
          **CozyStack Commit:** \`$COZYSTACK_COMMIT\`  
          
          **Asset Digests:**
          - **Kernel:** \`$KERNEL_DIGEST\`
          - **Initramfs:** \`$INITRAMFS_DIGEST\`
          
          **Container Image:**
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable
          \`\`\`
          
          **For AWS Bastion Matchbox Setup:**
          \`\`\`bash
          # Extract boot assets
          docker run --rm -v /opt/matchbox/assets:/output \\
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:demo-stable \\
            /output/talos/arm64/
          \`\`\`
          EOF

      - name: Commit updated docs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/LATEST-BUILD.md
          git commit -m "Update CozyStack ARM64 build: ${{ needs.build-cozystack-talos-arm64.outputs.talos-version }}" || exit 0
          git push