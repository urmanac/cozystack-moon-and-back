#cloud-config
write_files:
- path: /opt/boot-to-talos.sh
  permissions: "0755"
  content: |
    #!/bin/bash
    set -euo pipefail
    echo "ðŸš€ Starting boot-to-Talos transition..."
    
    # Install Docker for image operations
    apt-get update
    apt-get install -y docker.io
    systemctl start docker
    
    # Configure Docker to use registry caches (critical - no direct internet from private subnets)
    mkdir -p /etc/docker
    cat > /etc/docker/daemon.json << DOCKER_EOF
    {
      "registry-mirrors": ["http://10.10.1.100:5054"],
      "insecure-registries": ["10.10.1.100:5054"]
    }
    DOCKER_EOF
    systemctl restart docker
    
    # Pull custom Talos image via GHCR registry cache (port 5054)
    echo "ðŸ“¦ Pulling custom Talos image via bastion cache: 10.10.1.100:5054"
    echo "ðŸ” Image: ghcr.io/urmanac/cozystack-assets/talos/cozystack-spin-tailscale/talos:latest"
    
    # Pull from registry cache (nodes have no direct internet - critical)
    echo "ðŸ” Testing registry cache access..."
    curl -f http://10.10.1.100:5054/v2/ || {
      echo "âŒ Registry cache not accessible at 10.10.1.100:5054"
      exit 1
    }
    
    echo "ðŸ“¦ Pulling custom Talos image..."
    # Pull via registry cache since nodes have no direct internet
    docker pull 10.10.1.100:5054/urmanac/cozystack-assets/talos/cozystack-spin-tailscale/talos:latest || {
      echo "âŒ Failed to pull from registry cache"
      exit 1
    }
    
    # Tag for easier reference
    docker tag 10.10.1.100:5054/urmanac/cozystack-assets/talos/cozystack-spin-tailscale/talos:latest ghcr.io/urmanac/cozystack-assets/talos/cozystack-spin-tailscale/talos:latest
    
    # Extract Talos installer for kexec transition
    echo "ðŸ”„ Extracting Talos installer..."
    docker create --name talos-extract "ghcr.io/urmanac/cozystack-assets/talos/cozystack-spin-tailscale/talos:latest"
    mkdir -p /opt/talos-installer
    
    echo "âœ… Boot-to-Talos preparation complete"
    
runcmd:
- /opt/boot-to-talos.sh
final_message: "Ubuntu â†’ Talos transition initiated"
