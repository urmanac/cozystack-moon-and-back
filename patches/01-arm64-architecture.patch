From: Hephy Builder <hephy@urmanac.com>
Date: Sat, 16 Nov 2025 00:00:00 +0000
Subject: [PATCH 1/4] Add ARM64 architecture support to proven CozyStack build

Based on kingdonb/cozystack:merged-branches (c112ec63 â†’ c21b1a86)
This patch converts the proven x86_64 Spin+Tailscale build to ARM64 for AWS t4g instances.

Changes:
- Update arch field from amd64 to arm64 in profile generation
- Change paths from /usr/install/amd64/ to /usr/install/arm64/
- Update output filenames and Makefile targets for ARM64
- Keep proven extension versions and build pattern

---
 packages/core/installer/hack/gen-profiles.sh | 6 +++---
 packages/core/installer/Makefile            | 8 ++++----
 2 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/packages/core/installer/hack/gen-profiles.sh b/packages/core/installer/hack/gen-profiles.sh
index 1234567..abcdefg 100755
--- a/packages/core/installer/hack/gen-profiles.sh
+++ b/packages/core/installer/hack/gen-profiles.sh
@@ -50,12 +50,12 @@ for profile in $PROFILES; do
   cat > images/talos/profiles/$profile.yaml <<EOT
 # this file generated by hack/gen-profiles.sh
 # do not edit it
-arch: amd64
+arch: arm64
 platform: ${platform}
 secureboot: false
 version: ${TALOS_VERSION}
 input:
   kernel:
-    path: /usr/install/amd64/vmlinuz
+    path: /usr/install/arm64/vmlinuz
   initramfs:
-    path: /usr/install/amd64/initramfs.xz
+    path: /usr/install/arm64/initramfs.xz
   baseInstaller:
     imageRef: "ghcr.io/siderolabs/installer:${TALOS_VERSION}"
   systemExtensions:
@@ -72,4 +72,4 @@ output:
   outFormat: ${out_format}
 EOT
 done

diff --git a/packages/core/installer/Makefile b/packages/core/installer/Makefile
index abcdef1..1234567 100644
--- a/packages/core/installer/Makefile
+++ b/packages/core/installer/Makefile
@@ -45,10 +45,10 @@ image-talos:
 
 image-matchbox:
-	test -f ../../../_out/assets/kernel-amd64 || make talos-kernel
-	test -f ../../../_out/assets/initramfs-metal-amd64.xz || make talos-initramfs
+	test -f ../../../_out/assets/kernel-arm64 || make talos-kernel
+	test -f ../../../_out/assets/initramfs-metal-arm64.xz || make talos-initramfs
 	docker buildx build -f images/matchbox/Dockerfile ../../.. \
 		--tag $(REGISTRY)/matchbox:$(call settag,$(TAG)) \
 		--tag $(REGISTRY)/matchbox:$(call settag,$(TALOS_VERSION)-$(TAG)) \
 		--cache-from type=registry,ref=$(REGISTRY)/matchbox:latest \
 		--cache-to type=inline \