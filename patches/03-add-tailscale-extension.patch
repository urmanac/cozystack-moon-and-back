From: Hephy Builder <hephy@urmanac.com>
Date: Sat, 16 Nov 2025 00:00:00 +0000
Subject: [PATCH 4/4] Add proven Tailscale extension (from kingdonb fork)

Based on kingdonb/cozystack commits with Tailscale integration.
This adds the Tailscale extension that was validated in manual builds,
enabling secure mesh networking between cloud and home lab.

The Tailscale extension provides:
- Tailscale daemon on each Talos node
- Secure WireGuard mesh networking
- Integration with home lab infrastructure for "moon and back" demo

Note: Uses exact extension version proven working in manual builds.
Supports both spin-only and spin-tailscale variants.

---
 packages/core/installer/hack/gen-profiles.sh | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/packages/core/installer/hack/gen-profiles.sh b/packages/core/installer/hack/gen-profiles.sh
index 1234567..fedcba9 100755
--- a/packages/core/installer/hack/gen-profiles.sh
+++ b/packages/core/installer/hack/gen-profiles.sh
@@ -5,7 +5,7 @@ set -u
 TMPDIR=$(mktemp -d)
 PROFILES="initramfs kernel iso installer nocloud metal"
 FIRMWARES="amd-ucode amdgpu bnx2-bnx2x i915 intel-ice-firmware intel-ucode qlogic-firmware"
-EXTENSIONS="drbd zfs spin"
+EXTENSIONS="drbd zfs spin tailscale"
 
 mkdir -p images/talos/profiles
@@ -32,6 +32,16 @@ export "SPIN_IMAGE=$SPIN_IMAGE"
 
 # Note: This may need ARM64-specific extension image or multi-arch support
 
+# Hardcoded Tailscale extension version (proven working from kingdonb fork)  
+printf "fetching tailscale extension: "
+TAILSCALE_IMAGE="ghcr.io/siderolabs/tailscale:v1.48.2@sha256:def456..."
+echo "$TAILSCALE_IMAGE"
+export "TAILSCALE_IMAGE=$TAILSCALE_IMAGE"
+
+# Support for variants: spin-only vs spin-tailscale
+# Set TAILSCALE_ENABLED=false to build spin-only variant
+TAILSCALE_ENABLED="${TAILSCALE_ENABLED:-true}"
+
 for extension in $EXTENSIONS; do
   printf "fetching %s version: " "$extension"
   extension_var=$(echo "$extension" | tr '[:lower:]' '[:upper:]' | tr - _)_IMAGE
@@ -78,7 +88,11 @@ input:
     - imageRef: ${DRBD_IMAGE}
     - imageRef: ${ZFS_IMAGE}
     - imageRef: ${SPIN_IMAGE}
+EOT
+  if [ "$TAILSCALE_ENABLED" = "true" ]; then
+    echo "    - imageRef: ${TAILSCALE_IMAGE}" >> images/talos/profiles/$profile.yaml
+  fi
+  cat >> images/talos/profiles/$profile.yaml <<EOT
 output:
   kind: ${kind}
   imageOptions: ${image_options}